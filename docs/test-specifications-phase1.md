# テスト仕様書（フェーズ1）

## 概要

フェーズ1で実装する一時ユーザー向け勤怠管理機能のテスト仕様を定義します。

## テスト方針

- **段階的テスト**: 単体テスト → 結合テスト → システムテスト
- **手動テスト中心**: フェーズ1は手動テスト、フェーズ2以降で自動化
- **実環境重視**: レンタルサーバー環境での動作確認

## 1. 単体テスト（API）

### 1.1 一時ユーザー作成API

**テストケース**: POST /api/v1/user/temporary

| No | テストケース | 入力値 | 期待結果 | 優先度 |
|----|-------------|---------|----------|---------|
| 1.1.1 | 正常系：基本作成 | `{"display_name": "テストユーザー"}` | 201、user_id生成 | 高 |
| 1.1.2 | 正常系：名前なし | `{}` | 201、デフォルト名 | 中 |
| 1.1.3 | 異常系：不正JSON | `{invalid json}` | 400、バリデーションエラー | 高 |
| 1.1.4 | 異常系：長すぎる名前 | `{"display_name": "a".repeat(101)}` | 422、文字数エラー | 中 |
| 1.1.5 | 異常系：CSRFトークンなし | CSRFトークン省略 | 403、CSRFエラー | 高 |

### 1.2 勤怠データ作成API

**テストケース**: POST /api/v1/attendance

| No | テストケース | 入力値 | 期待結果 | 優先度 |
|----|-------------|---------|----------|---------|
| 1.2.1 | 正常系：基本作成 | `{"clock_in": "2025-01-15T09:00:00", "condition_code": 1}` | 201、データ作成 | 高 |
| 1.2.2 | 正常系：退勤込み | `{"clock_in": "09:00", "clock_out": "18:00", "memo": "テスト"}` | 201、完全データ | 高 |
| 1.2.3 | 異常系：必須項目なし | `{"memo": "テスト"}` | 422、clock_in必須エラー | 高 |
| 1.2.4 | 異常系：日時形式不正 | `{"clock_in": "invalid-date"}` | 422、形式エラー | 高 |
| 1.2.5 | 異常系：退勤＜出勤 | `{"clock_in": "18:00", "clock_out": "09:00"}` | 422、時刻順序エラー | 中 |
| 1.2.6 | 異常系：メモ長すぎ | `{"clock_in": "09:00", "memo": "a".repeat(1001)}` | 422、文字数エラー | 中 |
| 1.2.7 | 異常系：不正コンディション | `{"clock_in": "09:00", "condition_code": 99}` | 422、範囲エラー | 中 |

### 1.3 勤怠データ取得API

**テストケース**: GET /api/v1/attendance

| No | テストケース | 入力値 | 期待結果 | 優先度 |
|----|-------------|---------|----------|---------|
| 1.3.1 | 正常系：基本取得 | なし | 200、データ一覧 | 高 |
| 1.3.2 | 正常系：年月指定 | `?year=2025&month=01` | 200、フィルタ済み | 中 |
| 1.3.3 | 正常系：件数制限 | `?limit=10` | 200、10件まで | 中 |
| 1.3.4 | 正常系：データなし | 新規ユーザー | 200、空配列 | 中 |
| 1.3.5 | 異常系：不正年月 | `?year=abc&month=99` | 422、パラメータエラー | 低 |

### 1.4 勤怠データ更新API

**テストケース**: PUT /api/v1/attendance/{id}

| No | テストケース | 入力値 | 期待結果 | 優先度 |
|----|-------------|---------|----------|---------|
| 1.4.1 | 正常系：基本更新 | `{"memo": "更新テスト"}` | 200、データ更新 | 高 |
| 1.4.2 | 正常系：時刻変更 | `{"clock_in": "08:00", "clock_out": "17:00"}` | 200、時刻更新 | 高 |
| 1.4.3 | 異常系：存在しないID | 存在しないID | 404、NotFoundエラー | 高 |
| 1.4.4 | 異常系：他ユーザーのデータ | 他ユーザーのID | 404、NotFoundエラー | 高 |

### 1.5 勤怠データ削除API

**テストケース**: DELETE /api/v1/attendance/{id}

| No | テストケース | 入力値 | 期待結果 | 優先度 |
|----|-------------|---------|----------|---------|
| 1.5.1 | 正常系：基本削除 | 有効なID | 200、削除成功 | 高 |
| 1.5.2 | 異常系：存在しないID | 存在しないID | 404、NotFoundエラー | 高 |
| 1.5.3 | 異常系：他ユーザーのデータ | 他ユーザーのID | 404、NotFoundエラー | 高 |
| 1.5.4 | 異常系：重複削除 | 既に削除済みID | 404、NotFoundエラー | 中 |

## 2. 結合テスト

### 2.1 ユーザーフロー

| No | テストシナリオ | 手順 | 期待結果 | 優先度 |
|----|---------------|------|----------|---------|
| 2.1.1 | 初回利用フロー | 1. サイトアクセス<br>2. 一時ユーザー作成<br>3. 出勤登録<br>4. 退勤登録 | 完全な勤怠データ作成 | 高 |
| 2.1.2 | 編集フロー | 1. 勤怠データ作成<br>2. データ編集<br>3. 保存 | データ正常更新 | 高 |
| 2.1.3 | 削除フロー | 1. 勤怠データ作成<br>2. 削除実行<br>3. 確認 | データ削除、一覧から除外 | 高 |
| 2.1.4 | コンディション記録 | 1. 出勤時コンディション選択<br>2. 退勤時コンディション変更 | コンディション正常記録 | 中 |

### 2.2 セッション管理

| No | テストシナリオ | 手順 | 期待結果 | 優先度 |
|----|---------------|------|----------|---------|
| 2.2.1 | クッキー継続 | 1. 一時ユーザー作成<br>2. ブラウザ再起動<br>3. サイト再アクセス | 同一ユーザーとして認識 | 高 |
| 2.2.2 | クッキー期限切れ | 1. クッキー手動削除<br>2. API アクセス | 401エラー、再認証要求 | 中 |
| 2.2.3 | 異なるブラウザ | 1. ブラウザAで作成<br>2. ブラウザBでアクセス | 別ユーザーとして認識 | 中 |

## 3. システムテスト

### 3.1 ブラウザ互換性

| ブラウザ | バージョン | 動作確認項目 | 優先度 |
|----------|------------|--------------|---------|
| Chrome | 最新版 | 全機能 | 高 |
| Firefox | 最新版 | 全機能 | 高 |
| Safari | 最新版 | 全機能 | 中 |
| Edge | 最新版 | 全機能 | 中 |
| Chrome Mobile | 最新版 | レスポンシブ対応 | 高 |

### 3.2 パフォーマンステスト

| 項目 | 測定条件 | 目標値 | 測定方法 |
|------|----------|--------|----------|
| ページ読み込み | 初回アクセス | 3秒以内 | DevTools Performance |
| API レスポンス | 勤怠データ取得 | 1秒以内 | Postman/curl |
| データ保存 | 勤怠データ登録 | 2秒以内 | フォーム送信測定 |

### 3.3 セキュリティテスト

| 項目 | テスト内容 | 期待結果 | ツール |
|------|------------|----------|--------|
| XSS脆弱性 | スクリプト注入テスト | エスケープ処理動作 | 手動入力 |
| CSRF攻撃 | トークンなしリクエスト | 403エラー応答 | curl |
| SQLインジェクション | 特殊文字入力 | エラーなし、正常処理 | 手動入力 |

## 4. テストデータ

### 4.1 正常系テストデータ

```json
{
  "valid_attendance": [
    {
      "clock_in": "2025-01-15T09:00:00",
      "clock_out": "2025-01-15T18:00:00",
      "memo": "通常勤務",
      "condition_code": 1
    },
    {
      "clock_in": "2025-01-15T10:30:00",
      "clock_out": null,
      "memo": "午後から出勤",
      "condition_code": 2
    }
  ]
}
```

### 4.2 異常系テストデータ

```json
{
  "invalid_attendance": [
    {
      "clock_in": "",
      "memo": "必須項目なし"
    },
    {
      "clock_in": "invalid-date",
      "memo": "日時形式不正"
    },
    {
      "clock_in": "2025-01-15T18:00:00",
      "clock_out": "2025-01-15T09:00:00",
      "memo": "退勤＜出勤"
    }
  ]
}
```

## 5. テスト環境構築

### 5.1 必要環境

- **Webサーバー**: Apache/Nginx
- **PHP**: 8.0以上
- **MySQL**: 8.0以上
- **テストブラウザ**: Chrome, Firefox, Safari
- **開発ツール**: Postman, DevTools

### 5.2 データベース準備

```sql
-- テスト用データベース作成
CREATE DATABASE kinkan_test CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- テストユーザー作成
INSERT INTO users (email, display_name, is_temporary, created_at, updated_at) 
VALUES (null, 'テストユーザー1', true, NOW(), NOW());
```

### 5.3 設定ファイル

```php
// config/test.php
<?php
return [
    'database' => [
        'host' => 'localhost',
        'database' => 'kinkan_test',
        'username' => 'test_user',
        'password' => 'test_pass'
    ],
    'security' => [
        'csrf_enabled' => true,
        'session_timeout' => 1800 // 30分
    ]
];
```

## 6. テスト実行手順

### 6.1 事前準備

1. テスト環境の構築
2. データベースの初期化
3. テストデータの投入
4. 設定ファイルの確認

### 6.2 実行順序

1. **単体テスト**: API ごとに個別実行
2. **結合テスト**: ユーザーフローの確認
3. **システムテスト**: ブラウザでの動作確認
4. **パフォーマンステスト**: 負荷テスト
5. **セキュリティテスト**: 脆弱性確認

### 6.3 結果記録

- **テスト結果シート**: Excel/Googleスプレッドシート
- **不具合管理**: 発見した問題の記録
- **パフォーマンス測定**: 数値データの記録

## 7. 合格基準

- **単体テスト**: 高優先度テストケース100%合格
- **結合テスト**: 主要フロー100%合格
- **システムテスト**: 対象ブラウザでの動作確認
- **パフォーマンス**: 目標値以内での動作
- **セキュリティ**: 脆弱性なし

## 8. テスト自動化準備（フェーズ2以降）

- **PHPUnit**: 単体テスト自動化
- **Selenium**: ブラウザテスト自動化
- **CI/CD**: GitHub Actions 等での自動実行
