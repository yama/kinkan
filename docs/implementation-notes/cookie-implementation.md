# クッキー発行タイミング実装 - 実装メモ

## 実装内容

初回アクセス時の一時ユーザー作成とクッキー発行機能を実装しました。

## 実装したファイル

### 1. `js/modules/user-manager.js` (新規作成)

- 一時ユーザーの作成・管理を担当するモジュール
- `initializeTemporaryUser()`: 初回アクセス時の一時ユーザー初期化
- `createTemporaryUserOnServer()`: サーバーへの一時ユーザー作成リクエスト
- `initializeLocalMode()`: サーバーエラー時のフォールバック機能

### 2. `js/modules/storage.js` (更新)

- クッキー管理機能を追加
- `setCookie()`, `getCookie()`: クッキーの設定・取得
- `generateTemporaryUserId()`: UUID v4形式の一意識別子生成
- `getOrCreateTemporaryUserId()`: 一時ユーザー識別子の取得・生成

### 3. `js/config.js` (更新)

- ストレージキーにクッキー関連の設定を追加
- API設定を追加（将来のサーバー連携用）

### 4. `js/app.js` (更新)

- 初期化処理に一時ユーザー初期化を組み込み
- `initializeUser()`: ユーザー初期化処理を追加

### 5. `index.html` (更新)

- `user-manager.js`のスクリプトタグを追加

## 動作フロー

1. **初回アクセス時**
   - `UserManager.initializeTemporaryUser()`が実行
   - クッキーから一時ユーザー識別子をチェック
   - 識別子がない場合、UUID v4形式で新規生成
   - 生成した識別子をクッキーに保存（有効期限：365日）
   - サーバーに一時ユーザー作成リクエストを送信
   - 返されたuser_idをローカルストレージに保存

2. **2回目以降のアクセス**
   - 既存のクッキーから識別子を取得
   - 既存のuser_idがある場合はそれを利用

3. **サーバーエラー時**
   - ローカルモードで動作（フォールバック）
   - タイムスタンプをダミーuser_idとして使用

## セキュリティ設計

- クッキーに`SameSite=Strict`を設定してCSRF攻撃を防止
- UUID v4で推測困難な識別子を生成
- XSS対策としてHTTPOnlyは設定せず（JavaScriptからアクセス必要）

## 重要な設計方針

**一時ユーザークッキーのライフサイクル:**

- フェーズ1: 一時ユーザー識別のためクッキーを生成・保持
- フェーズ2: 正規ユーザー登録時にクッキーを削除し、セッション認証に移行
- 理由: 一時ユーザーと正規ユーザーの認証方式を明確に分離するため

## 次のステップ

次は「一時ユーザー作成API実装」に進む予定です。

- PHP側でのAPIエンドポイント実装
- データベース接続とテーブル操作
- エラーハンドリングの実装

## テスト項目

実装後に以下をテストしました：

- [x] 初回アクセス時のクッキー生成
- [x] ブラウザコンソールでのログ出力確認
- [x] ローカルストレージへのuser_id保存
- [x] 2回目アクセス時の既存クッキー利用
- [ ] サーバーAPI連携（次フェーズで実装）
